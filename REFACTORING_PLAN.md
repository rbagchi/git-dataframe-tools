# Refactoring Plan: git-scoreboard Architecture

This document outlines the phased approach to refactor the `git-scoreboard` project into a modular library and two distinct command-line applications. The goal is to improve reusability, performance, and maintainability, while providing a flexible and user-friendly experience.

## Development Environment

We will be using `uv` to manage the Python environment, ensuring a separate and consistent environment for development and testing.

## New Architecture Overview

The project will be structured into three main components:

1.  **`git2df` Library:** A Python library responsible for extracting Git repository data and transforming it into a Pandas DataFrame.
2.  **`git-extract-commits` CLI:** A command-line application that uses the `git2df` library to extract commit data from a Git repository, apply filtering similar to `git log`, and output the results as a Parquet file.
3.  **`git-scoreboard` CLI:** The existing `git-scoreboard` application, refactored to accept a Parquet file (generated by `git-extract-commits`) or directly use the `git2df` library, performing analysis and presentation.

## Phased Refactoring Approach

### Phase 1: Establish `git2df` Library (CLI-based)

**Objective:** Create the core `git2df` library, initially relying on shelling out to the `git` CLI for data extraction, but designed for future `pygit2` integration.

*   **Action Items (Easy Steps):**
    *   **Step 1: Create the `git2df` Package Structure**
        *   **Objective:** Set up the basic directory and file structure for the new `git2df` library.
        *   **Action:** Create the directory `src/git2df/` and an empty `__init__.py` file inside it.
    *   **Step 2: Extract `_run_git_command` Utility**
        *   **Objective:** Move the core functionality for executing `git` commands and capturing their output into the new library.
        *   **Action:** Identify the function or logic responsible for running `git log` (likely in `src/git_scoreboard/config_models.py` or `src/git_scoreboard/git_stats.py`), and copy it into a new file `src/git2df/git_cli_utils.py`. Adapt it to be a standalone utility function.
    *   **Step 3: Copy Raw `git log` Output Parsing Logic**
        *   **Objective:** Transfer the existing logic that takes raw `git log` text and parses it into a structured format (e.g., a list of dictionaries).
        *   **Action:** Copy the relevant parsing functions (e.g., `_parse_git_data_internal` or similar from `src/git_scoreboard/git_stats.py`) into `src/git2df/git_parser.py`.
    *   **Step 4: Implement Basic `GitCliBackend` Class**
        *   **Objective:** Create the initial structure for the `GitCliBackend` that will encapsulate `git` CLI interactions.
        *   **Action:** In `src/git2df/backends.py`, define a class `GitCliBackend`. Give it a method (e.g., `get_raw_log_output`) that uses the `_run_git_command` utility (from Step 2) to execute `git log` and return its raw string output.
    *   **Step 5: Convert Parsed Data to Basic Pandas DataFrame**
        *   **Objective:** Create a function that takes the structured data from the parser (Step 3) and converts it into a Pandas DataFrame with essential columns.
        *   **Action:** In `src/git2df/dataframe_builder.py`, create a function (e.g., `build_commits_df`) that accepts the output from the parser and returns a Pandas DataFrame containing at least `hash`, `author_name`, `author_email`, `commit_date`, and `message`.
    *   **Step 6: Create Public `get_commits_df` Function (No Filters)**
        *   **Objective:** Provide the main entry point for the `git2df` library.
        *   **Action:** In `src/git2df/__init__.py`, define a public function `get_commits_df(repo_path: str)`. This function should instantiate `GitCliBackend`, call its `get_raw_log_output` method, pass the raw output to the parser, and then use the `build_commits_df` function to return the DataFrame.
    *   **Step 7: Add Basic Filtering to `GitCliBackend`**
        *   **Objective:** Integrate initial filtering capabilities into the `GitCliBackend`.
        *   **Action:** Modify the `get_raw_log_output` method in `GitCliBackend` to accept simple filtering arguments (e.g., `since`, `until`) and incorporate them into the `git log` command. Update `get_commits_df` to pass these arguments.
    *   **Step 8: Write a Minimal Unit Test for `git2df`**
        *   **Objective:** Verify that the basic `git2df` functionality works.
        *   **Action:** Create a new test file (e.g., `tests/test_git2df_basic.py`). Write a test that calls `git2df.get_commits_df('.')` (or a small test repo) and asserts that a Pandas DataFrame is returned, it's not empty, and contains the expected core columns.

### Phase 2: Develop `git-extract-commits` CLI

**Objective:** Create a new CLI application that leverages `git2df` to extract filtered commit data and save it to a Parquet file.

*   **Action Items:**
    *   Create a new entry point for `git-extract-commits` (e.g., `src/git_scoreboard/git_extract_commits.py`).
    *   Implement command-line argument parsing for filtering options (e.g., `--since`, `--until`, `--author`, `--grep`), mirroring `git log` functionality.
    *   Use `git2df.get_commits_df()` to retrieve the filtered commit data.
    *   Implement logic to save the resulting Pandas DataFrame to a Parquet file.
    *   Add command-line options for specifying the output Parquet file path.
    *   Ensure user-friendly error handling and clear feedback messages.

### Phase 3: Refactor `git-scoreboard` CLI

**Objective:** Modify the existing `git-scoreboard` application to consume data from `git2df` or a Parquet file, focusing solely on analysis and presentation.

*   **Action Items:**
    *   Modify the `git-scoreboard` entry point (`src/git_scoreboard/scoreboard.py`).
    *   Update argument parsing to accept either a Git repository path (which will trigger internal `git2df` usage) or a path to a Parquet file.
    *   Remove all direct Git interaction logic from `scoreboard.py`.
    *   Adapt the existing analysis and presentation logic to work with the Pandas DataFrame provided by `git2df` or loaded from Parquet.
    *   Ensure the `--pandas` flag (for `git_stats_pandas.py`) continues to function correctly, now operating on the standardized DataFrame.
    *   Update existing tests (`test_scoreboard.py`, etc.) to reflect the new data input mechanism.

### Phase 4 (Future): Integrate `pygit2` Backend

**Objective:** Implement a `pygit2`-based backend for `git2df` to improve performance and provide an alternative to the `git` CLI.

*   **Action Items:**
    *   Develop a `Pygit2Backend` class within `git2df` that implements the same interface as `GitCliBackend`.
    *   Implement the logic to extract commit data using `pygit2`.
    *   Update the `git2df` configuration mechanism to allow users to select `Pygit2Backend` as the preferred backend.
    *   Thoroughly test the `Pygit2Backend` for correctness and performance.

## Configuration Strategy

*   **Mimic Git Hierarchy:** Configuration will follow a hierarchy similar to Git (e.g., project-specific overrides user-specific, which overrides system-wide defaults).
*   **Dedicated Configuration:** Configuration settings will be stored in a dedicated file (e.g., `.git-scoreboard-config` or a section within `pyproject.toml`) rather than using `git config` or modifying `.git/config`.
*   **Intelligent Defaults:** Sensible defaults will be provided, with options for command-line and environment variable overrides.

## Error Handling and User Feedback

*   All CLI applications will aim to provide clear, helpful, and actionable error messages.
*   Sensible defaults will be used to minimize configuration burden on the user.
*   Output will be designed to be more user-friendly than typical raw `git` command output.
